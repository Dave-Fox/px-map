<!-- Common imports -->
<link rel="import" href="../../polymer/polymer.html" />
<link rel="import" href="../../px-polymer-font-awesome/px-polymer-font-awesome.html" />
<link rel="import" href="../../iron-ajax/iron-ajax.html" />

<!-- Common demo imports -->
<link rel="import" href="../../px-demo/px-demo-header.html" />
<link rel="import" href="../../px-demo/px-demo-api-viewer.html" />
<link rel="import" href="../../px-demo/px-demo-footer.html" />
<link rel="import" href="../../px-demo/px-demo-configs.html" />
<link rel="import" href="../../px-demo/px-demo-props.html" />
<link rel="import" href="../../px-demo/px-demo-interactive.html" />
<link rel="import" href="../../px-demo/px-demo-component-snippet.html" />
<link rel="import" href="../../px-demo/css/px-demo-styles.html" />

<!-- Imports for this component -->
<link rel="import" href="../px-map.html" />
<link rel="import" href="../px-map-tile-layer.html" />
<link rel="import" href="../px-map-layer-geojson.html" />

<!-- Demo DOM module -->
<dom-module id="px-map-layer-geojson-demo">
  <template>
  <style include="px-demo-styles" is="custom-style"></style>

  <!-- Header -->
  <px-demo-header
      module-name="px-map-layer-geojson"
      parent-name="px-map"
      description="The px-map-layer-geojson subcomponent draws GeoJSON data as vectors on the map.">
  </px-demo-header>

  <!-- Interactive -->
  <px-demo-interactive>
    <!-- Configs -->
    <px-demo-configs configs="[[configs]]" props="{{props}}" chosen-config="{{chosenConfig}}"></px-demo-configs>

    <!-- Props -->
    <px-demo-props props="{{props}}" config="[[chosenConfig]]"></px-demo-props>

    <!-- Load GeoJSON from file -->
    <iron-ajax url="px-map-layer-geojson-data.json" last-response="{{props.data.value}}" on-response="_addDrawTools" auto></iron-ajax>

    <!-- Component ---------------------------------------------------------->
    <px-demo-component>
      <div style="height:600px;width:800px;display:flex">
        <px-map zoom="12" flex-to-size disable-touch-zoom lat="52.2352" lng="0.1127">
          <px-map-tile-layer url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"></px-map-tile-layer>
          <px-map-layer-geojson
              data="{{props.data.value}}"
              feature-style="{{props.featureStyle.value}}"
              show-feature-properties="{{props.showFeatureProperties.value}}">
          </px-map-layer-geojson>
        </px-map>
      </div>
    </px-demo-component>
    <!-- END Component ------------------------------------------------------>

    <px-demo-component-snippet
        element-properties="{{props}}"
        element-name="px-map-layer-geojson"
        links-includes='["px-map/px-map.html","px-map/px-map-tile-layer.html","px-map/px-map-layer-geojson.html"]'>
    </px-demo-component-snippet>
  </px-demo-interactive>

  <!-- API Viewer -->
  <px-demo-api-viewer
    source="px-map-layer-geojson"
    mark-private="[[apiMarkPrivate]]">
  </px-demo-api-viewer>

  <!-- Footer -->
  <px-demo-footer></px-demo-footer>
</template>
</dom-module>

  <script>
    Polymer({
      is: 'px-map-layer-geojson-demo',

      properties: {

        /**
         * Note: The actual data/values for `props` are placed in `this.demoProps`
         * to create a static reference that Polymer shouldn't overwrite.
         *
         * @property props
         * @type {Object}
         */
        props: {
          type: Object,
          value: function(){ return this.demoProps; }
        },

        /**
         * An array of pre-configured `props` that can be used to provide the user
         * with a set of common examples. These configs will be made available
         * as a set of tabs the user can click that will automatically change
         * the `props` to specific values.
         *
         * @property configs
         * @type {Array}
         */
        configs: {
          type: Array,
          value: function(){
            return [
              { configName: "Basic",
                configReset: true }
              ]
          }
        },

        apiMarkPrivate: {
          type: Array,
          value: function() {
            return [
              "notifyInstReady",
              "canAddInst",
              "shouldAddInst",
              "addInst",
              "shouldRemoveInst",
              "removeInst",
              "shouldUpdateInst",
              "updateInst",
              "createInst",
              "getStyle",
              "getInstOptions",
              "bindEvents",
              "unbindAllEvents",
              "addProperties",
              "extendObj",
              "getShadyScope",
              "isShadyScoped"
            ]
          }
        }
      },

      _addDrawTools: function() {
        /**
         * Hacky Leaflet.draw testing
         */

        //Add circle marker editing fix
        //Credit to https://github.com/iCarto

        L.Edit.CircleMarker = L.Edit.SimpleShape.extend({
          _createMoveMarker: function () {
            let center = this._shape.getLatLng();

            this._moveMarker = this._createMarker(center, this.options.moveIcon);
          },

          _createResizeMarker: function () {
            // To avoid an undefined check in L.Edit.SimpleShape.removeHooks
            this._resizeMarkers = [];
          },

          _move: function (latlng) {
            if (this._resizeMarkers.length) {
              let resizemarkerPoint = this._getResizeMarkerPoint(latlng);
              // Move the resize marker
              this._resizeMarkers[0].setLatLng(resizemarkerPoint);
            }

            // Move the circle
            this._shape.setLatLng(latlng);

            this._map.fire(L.Draw.Event.EDITMOVE, { layer: this._shape });
          },
        });

        L.CircleMarker.addInitHook(function () {
          if (L.Edit.CircleMarker) {
            this.editing = new L.Edit.CircleMarker(this);

            if (this.options.editable) {
              this.editing.enable();
            }
          }

          this.on('add', function () {
            if (this.editing && this.editing.enabled()) {
              this.editing.addHooks();
            }
          });

          this.on('remove', function () {
            if (this.editing && this.editing.enabled()) {
              this.editing.removeHooks();
            }
          });
        });

        //End fix

        setTimeout(() => {
          const vectLayer = document.querySelector('px-map-layer-geojson');
          const map = vectLayer.parentNode.elementInst;
          map.options.drawControl = true;

          let editableLayers = new L.FeatureGroup([]).addTo(map);
          this.drawingLayer = editableLayers;
          vectLayer.elementInst.getLayers().forEach(function (layer) {
            editableLayers.addLayer(layer)
          });

          const drawControl = new L.Control.Draw({
            draw: false,
            edit: {
              featureGroup: editableLayers
            }
          });
          map.addControl(drawControl);

          map.on(L.Draw.Event.CREATED, function (e) {
            let type = e.layerType,
              layer = e.layer;

            if (type === 'marker') {
              let latlng = e.layer.getLatLng();
              layer = new L.CircleMarker(latlng, {radius: 5});
            }

            editableLayers.addLayer(layer);
            console.log(editableLayers.getLayers().length);
          });
        }, 10);

        const vectorlayer = document.querySelector('px-map-layer-geojson');
        const map = vectorlayer.parentNode.elementInst;
        let polyline = this.createButton('Draw Line', new L.Draw.Polyline(map, {icon: new L.DivIcon({iconSize: new L.Point(8, 8), className: 'leaflet-div-icon leaflet-editing-icon'})}), 0, map);
        let polygon = this.createButton('Draw Polygon', new L.Draw.Polygon(map, {icon: new L.DivIcon({iconSize: new L.Point(8, 8), className: 'leaflet-div-icon leaflet-editing-icon'})}), 110, map);
        let point = this.createButton('Draw Point', new L.Draw.Marker(map, {icon: new L.DivIcon({iconSize: new L.Point(8, 8), className: 'leaflet-div-icon leaflet-editing-icon'})}), 220, map);

        vectorlayer.parentNode.appendChild(polyline);
        vectorlayer.parentNode.appendChild(polygon);
        vectorlayer.parentNode.appendChild(point);

        /*End hacky leaflet drawing*/
      },

      createButton: function(text, handler, offset, map) {
        let button = document.createElement('button');
        button.onclick = () => {
          handler.enable();
          map.eachLayer( (layer) => {
            if(layer instanceof L.FeatureGroup && layer === this.drawingLayer){
              console.log(layer.toGeoJSON());
            }
          })
        };
        button.innerHTML = text;
        button.style.width = '100px';
        button.style.position = 'absolute';
        button.style.top = '0';
        button.style.left = offset + 'px';
        button.style.zIndex = '9999';

        return button;
      },

      /**
       * A reference for `this.props`. Read the documentation there.
       *
       * @property demoProps
       * @type {Object}
       */
      demoProps: {
        data: {
          type: Object,
          defaultValue: {},
          inputType: 'code:JSON'
        },

        featureStyle:{
          type: String,
          defaultValue: {"color": "#3E87E8"},
          inputType: 'code:JSON'
        },

        showFeatureProperties: {
          type: Boolean,
          value: true,
          inputType: 'toggle'
        },

        parentComponent: {
          value: ['<div style="height:400px;width:600px;display:flex"><px-map flex-to-size disable-touch-zoom><px-map-tile-layer url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"></px-map-tile-layer> ', '</px-map></div>']
        }
      }
    });
  </script>
